<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√†i N·ªôp | Gi√°o Vi√™n 6A3</title>
    <style>
        /* Thi·∫øt l·∫≠p chung */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f0f8ff; 
            color: #333;
        }
        /* --- HEADER (Gi·ªØ nguy√™n ƒë√£ s·ª≠a l·ªói) --- */
        .header {
            background-color: #388E3C; 
            color: white;
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.8em;
            font-weight: bold;
        }
        .nav-links {
            display: flex; 
            align-items: center;
        }
        .nav-links a {
            color: white; 
            text-decoration: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            margin-left: 10px;
            transition: background-color 0.3s;
        }
        .nav-links a.active {
            background-color: #4CAF50; 
            font-weight: bold;
        }
        #user-info-container {
            display: flex; 
            align-items: center; 
            margin-left: 20px;
        }
        #welcome-user {
            color: #FFC107; 
            font-weight: bold; 
            margin-right: 20px; 
            font-size: 1.1em;
            padding: 0; 
        }
        #logout-btn {
            background-color: #e74c3c; 
            cursor: pointer; 
            padding: 8px 15px;
        }
        #logout-btn:hover { 
            background-color: #c0392b; 
        }
        /* --- K·∫æT TH√öC HEADER --- */

        /* Main Content */
        .main-area {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        /* --- KH·ªêI M·ªöI: Thanh C√¥ng c·ª• Qu·∫£n l√Ω v√† B·ªô L·ªçc --- */
        .management-tools {
            background-color: #e8f5e9; /* N·ªÅn xanh nh·∫°t h∆°n */
            border: 1px solid #c8e6c9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .filter-group label {
            font-weight: bold;
            color: #388E3C;
        }
        .filter-group select, .filter-group input[type="search"] {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em;
            min-width: 150px;
        }
        #search-input {
            min-width: 250px;
        }
        .summary-note {
            font-style: italic;
            color: #555;
            font-size: 0.95em;
        }
        /* End Kh·ªëi M·ªõi */

        /* L·ªãch s·ª≠ B√†i N·ªôp */
        .history-section h2 {
            font-size: 2.2em; color: #388E3C; border-bottom: 3px solid #FFC107; padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .history-table {
            width: 100%; border-collapse: collapse; background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
            vertical-align: middle;
        }
        .history-table th {
            background-color: #388E3C; color: white; font-weight: bold;
        }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Tr·∫°ng th√°i */
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .status-new { background-color: #FFC107; color: #333; }
        .status-checked { background-color: #4CAF50; color: white; }

        /* N√∫t Xem v√† Ch·∫•m */
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 5px;
            transition: opacity 0.2s;
        }
        .btn-view { background-color: #3498db; color: white; }
        .btn-check { background-color: #2ecc71; color: white; }
        .btn-revert { background-color: #f39c12; color: white; }

        /* Footer */
        .footer {
            padding: 20px; text-align: center; background-color: #333;
            color: white; font-size: 0.9em; margin-top: 40px;
        }
    </style>
</head>
<body onload="checkTeacherAccess()">
    <div class="header">
        <div class="logo">
            <span>L·ªöP 6A3 (QU·∫¢N L√ù)</span>
        </div>
        <div class="nav-links">
            <a href="trang_chu_gv.html">Trang Ch·ªß</a> 
            <a href="#" class="active">Ch·∫•m B√†i</a> 
            
            <div id="user-info-container">
                <span id="welcome-user"></span>
                <a href="#" onclick="logout()" id="logout-btn">ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="management-tools">
            <div class="filter-group">
                <label for="status-filter">Tr·∫°ng th√°i:</label>
                <select id="status-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="Ch∆∞a ch·∫•m">Ch∆∞a ch·∫•m</option>
                    <option value="ƒê√£ ch·∫•m">ƒê√£ ch·∫•m</option>
                </select>

                <label for="type-filter">Lo·∫°i b√†i:</label>
                <select id="type-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="video">Video/Thuy·∫øt tr√¨nh</option>
                    <option value="file">T√†i li·ªáu/File</option>
                    <option value="link">Li√™n k·∫øt</option>
                </select>

                <input type="search" id="search-input" placeholder="T√¨m ki·∫øm theo t√™n HS ho·∫∑c T√™n B√†i..." onkeyup="filterSubmissions()">
            </div>
            <div class="summary-note">
                <p>T·ªïng c·ªông: <span id="total-submissions-display" style="font-weight: bold;">0</span> b√†i n·ªôp.</p>
            </div>
        </div>
        
        <div class="history-section">
            <h2>üìù Danh S√°ch B√†i N·ªôp C·ªßa H·ªçc Sinh</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªçc Sinh</th>
                        <th>T√™n B√†i T·∫≠p</th>
                        <th>Lo·∫°i</th>
                        <th>Th·ªùi gian N·ªôp</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>ƒêi·ªÉm s·ªë</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="all-submissions-list">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        ¬© 2025 L·ªõp 6A3 Chuy√™n Anh | H·ªá th·ªëng Qu·∫£n L√Ω.
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script src="db_submissions.js"></script>
<script>
    let allSubmissions = []; // L∆∞u tr·ªØ b√†i n·ªôp t·ª´ Firebase
    let userDisplayNameMap = {}; // L∆∞u tr·ªØ t√™n hi·ªÉn th·ªã (cho tra c·ª©u HS)
    
    // --- 1. CH·ª®C NƒÇNG H·ªñ TR·ª¢: L·∫§Y V√Ä √ÅNH X·∫† DANH S√ÅCH NG∆Ø·ªúI D√ôNG T·ª™ FIREBASE ---
    function loadUserMapFromFirebase() {
        return database.ref('users').once('value')
            .then(snapshot => {
                userDisplayNameMap = {};
                snapshot.forEach(childSnapshot => {
                    const uid = childSnapshot.key;
                    const userData = childSnapshot.val();
                    if (userData.role === 'hs') {
                        userDisplayNameMap[uid] = userData.displayName || 'H·ªçc Sinh';
                    }
                });
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng:", error);
            });
    }
    
    // --- 2. CH·ª®C NƒÇNG CH√çNH: KI·ªÇM TRA QUY·ªÄN V√Ä T·∫¢I D·ªÆ LI·ªÜU ---
    function checkTeacherAccess() {
        auth.onAuthStateChanged(user => {
            if (user) {
                database.ref('users/' + user.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        const isTeacher = userData && userData.role === 'gv';
                        
                        if (!isTeacher) {
                            auth.signOut();
                            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Gi√°o vi√™n.');
                            window.location.replace('dangnhap.html');
                            return;
                        }
                        
                        // *** ƒêO·∫†N S·ª¨A L·ªñI QUAN TR·ªåNG: Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng sau khi x√°c th·ª±c ***
                        const loggedInDisplayName = userData.displayName || 'Gi√°o vi√™n';
                        document.getElementById('welcome-user').textContent = `Xin ch√†o, ${loggedInDisplayName}!`;
                        
                        // T·∫£i danh s√°ch ng∆∞·ªùi d√πng v√† sau ƒë√≥ b·∫Øt ƒë·∫ßu l·∫Øng nghe b√†i n·ªôp
                        loadUserMapFromFirebase().then(loadAllSubmissionsFromFirebase);
                        // *******************************************************************
                    })
                    .catch(error => {
                         console.error("L·ªói ki·ªÉm tra role:", error);
                         alert("L·ªói b·∫£o m·∫≠t. Vui l√≤ng th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i.");
                         auth.signOut();
                         window.location.replace('dangnhap.html');
                    });

            } else {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang qu·∫£n l√Ω.');
                window.location.replace('dangnhap.html');
            }
        });
    }
    
    // --- 3. T·∫¢I T·∫§T C·∫¢ B√ÄI N·ªòP T·ª™ FIREBASE REALTIME DATABASE ---
    function loadAllSubmissionsFromFirebase() {
        database.ref('submissions').on('value', (snapshot) => {
            allSubmissions = [];
            snapshot.forEach(childSnapshot => {
                const submission = childSnapshot.val();
                submission.firebaseKey = childSnapshot.key; 
                allSubmissions.push(submission);
            });
            filterSubmissions(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        }, (error) => {
            console.error("L·ªói khi t·∫£i b√†i n·ªôp:", error);
            alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i n·ªôp t·ª´ h·ªá th·ªëng.");
        });
    }
    
    // --- 4. H√ÄM ƒêƒÇNG XU·∫§T (S·ª≠ d·ª•ng Firebase Auth) ---
    function logout() {
        auth.signOut().then(() => {
            localStorage.removeItem('role'); 
            window.location.replace('trang_chu.html');
        }).catch(error => {
            console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
            window.location.replace('trang_chu.html');
        });
    }

    // --- 5. H√ÄM CH·∫§M ƒêI·ªÇM (C·∫≠p nh·∫≠t ƒë·ªÉ l∆∞u l√™n Firebase) ---
    function markSubmission(firebaseKey) {
        const submissionToMark = allSubmissions.find(sub => sub.firebaseKey === firebaseKey);
        
        if (!submissionToMark) {
            alert("Kh√¥ng t√¨m th·∫•y b√†i n·ªôp n√†y.");
            return;
        }
        
        const studentUid = submissionToMark.studentUid;
        const studentName = submissionToMark.displayName || userDisplayNameMap[studentUid] || 'H·ªçc Sinh';
        const title = submissionToMark.title;
        const currentStatus = submissionToMark.status;
        const currentScore = submissionToMark.score !== undefined && submissionToMark.score !== null ? submissionToMark.score : 'Ch∆∞a c√≥';
        
        if (currentStatus === 'ƒê√£ ch·∫•m') {
            const action = confirm(`B√†i t·∫≠p "${title}" c·ªßa ${studentName} ƒë√£ ƒë∆∞·ª£c ch·∫•m (${currentScore}/10).\n\nNh·∫•n OK ƒë·ªÉ H·ª¶Y CH·∫§M (ƒê∆∞a v·ªÅ tr·∫°ng th√°i ch∆∞a ch·∫•m), nh·∫•n Cancel ƒë·ªÉ CH·∫§M L·∫†I.`);
            
            let updates = {};

            if (action) { 
                updates.status = 'Ch∆∞a ch·∫•m';
                updates.score = null;
                alert(`ƒê√£ h·ªßy ch·∫•m b√†i "${title}" c·ªßa ${studentName}.`);
            } else { 
                let score = prompt(`CH·∫§M L·∫†I cho b√†i "${title}" c·ªßa ${studentName}.\nƒêi·ªÉm hi·ªán t·∫°i: ${currentScore}/10. Nh·∫≠p ƒëi·ªÉm m·ªõi (0-10):`);
                if (score === null) return; 
                score = parseFloat(score);

                if (isNaN(score) || score < 0 || score > 10) {
                    alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                    return;
                }

                updates.status = 'ƒê√£ ch·∫•m';
                updates.score = score;
                alert(`ƒê√£ c·∫≠p nh·∫≠t ƒëi·ªÉm ${score}/10 cho b√†i "${title}" c·ªßa ${studentName}.`);
            }
            
            database.ref('submissions/' + firebaseKey).update(updates)
                .catch(error => {
                    console.error("L·ªói c·∫≠p nh·∫≠t Firebase:", error);
                    alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm l√™n h·ªá th·ªëng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
                });
            
        } else { 
            let score = prompt(`Ch·∫•m ƒëi·ªÉm cho b√†i "${title}" c·ªßa ${studentName}.\nNh·∫≠p ƒëi·ªÉm (0-10):`);
            if (score === null) return; 
            score = parseFloat(score);

            if (isNaN(score) || score < 0 || score > 10) {
                alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                return;
            }
            
            const updates = {
                status: 'ƒê√£ ch·∫•m',
                score: score
            };
            
            database.ref('submissions/' + firebaseKey).update(updates)
                .then(() => {
                     alert(`ƒê√£ ch·∫•m ƒëi·ªÉm ${score}/10 cho b√†i "${title}" c·ªßa ${studentName}.`);
                })
                .catch(error => {
                     console.error("L·ªói c·∫≠p nh·∫≠t Firebase:", error);
                     alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm l√™n h·ªá th·ªëng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
                });
        }
    }
    
    // --- C√ÅC H√ÄM H·ªñ TR·ª¢ HI·ªÇN TH·ªä (Gi·ªØ nguy√™n) ---

    function displayType(type) {
        switch(type) {
            case 'video': return 'Video/TT';
            case 'file': return 'T√†i li·ªáu/File';
            case 'link': return 'Li√™n k·∫øt';
            default: return 'Kh√°c';
        }
    }
    
    function viewSubmission(link) {
        if (!link || link.trim() === '') {
            alert("B√†i n·ªôp kh√¥ng c√≥ li√™n k·∫øt ƒë·ªÉ m·ªü.");
            return;
        }
        
        let finalLink = link.trim(); 

        if (finalLink.startsWith("file:")) {
            alert("B√†i n·ªôp n√†y l√† d·∫°ng File (Ghi ch√∫). Vui l√≤ng y√™u c·∫ßu h·ªçc sinh g·ª≠i file g·ªëc qua k√™nh kh√°c.");
            return;
        }
        
        if (!(finalLink.startsWith("http://") || finalLink.startsWith("https://"))) {
            finalLink = `https://${finalLink}`;
        }

        window.open(finalLink, '_blank');
    }

    /* --- H√ÄM L·ªåC V√Ä HI·ªÇN TH·ªä (filterSubmissions) --- */
    function filterSubmissions() {
        const statusFilter = document.getElementById('status-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const tableBody = document.getElementById('all-submissions-list');
        tableBody.innerHTML = ''; 
        
        const filteredSubmissions = allSubmissions.filter(sub => {
            const studentUid = sub.studentUid; 
            // T√™n ∆∞u ti√™n displayName t·ª´ b√†i n·ªôp, sau ƒë√≥ l√† Map tra c·ª©u, cu·ªëi c√πng l√† UID
            const studentName = (sub.displayName || userDisplayNameMap[studentUid] || sub.studentUid || 'L·ªói T√™n').toLowerCase(); 
            
            const title = sub.title ? sub.title.toLowerCase() : '';
            
            const statusMatch = statusFilter === 'all' || sub.status === statusFilter;
            const typeMatch = typeFilter === 'all' || sub.type === typeFilter;
            const searchMatch = studentName.includes(searchInput) || 
                                title.includes(searchInput) ||
                                (studentUid && studentUid.includes(searchInput)); 
            
            return statusMatch && typeMatch && searchMatch;
        });

        // S·∫Øp x·∫øp d·ªØ li·ªáu
        filteredSubmissions.sort((a, b) => {
            if (a.status === 'Ch∆∞a ch·∫•m' && b.status !== 'Ch∆∞a ch·∫•m') return -1;
            if (a.status !== 'Ch∆∞a ch·∫•m' && b.status === 'Ch∆∞a ch·∫•m') return 1;
            return new Date(b.date) - new Date(a.date);
        });

        document.getElementById('total-submissions-display').textContent = filteredSubmissions.length;

        if (filteredSubmissions.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y b√†i n·ªôp n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc.</td></tr>'; 
             return;
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu
        filteredSubmissions.forEach((sub, index) => {
            const badgeClass = sub.status === 'Ch∆∞a ch·∫•m' ? 'status-new' : 'status-checked';
            
            let actionButtonText;
            let actionButtonClass;
            let scoreText;

            if (sub.status === 'Ch∆∞a ch·∫•m') {
                actionButtonText = 'Ch·∫•m B√†i';
                actionButtonClass = 'btn-check';
                scoreText = '<span style="color: #999;">--</span>'; 
            } else {
                actionButtonText = 'Ch·∫•m L·∫°i/H·ªßy';
                actionButtonClass = 'btn-revert';
                const score = sub.score !== undefined && sub.score !== null ? parseFloat(sub.score).toFixed(1) : '<span style="color: red;">L·ªói</span>';
                scoreText = `<span style="font-weight: bold; color: #E67E22;">${score}</span>/10`; 
            }
            
            let linkToView = sub.link || ''; 
            
            const studentUid = sub.studentUid;
            const studentDisplayName = sub.displayName || userDisplayNameMap[studentUid] || 'L·ªói T√™n';
            
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td style="font-weight: 600;">${studentDisplayName} (<span style="font-style: italic; color: #666;">ID: ${studentUid.substring(0, 5)}...</span>)</td>
                    <td>${sub.title}</td>
                    <td>${displayType(sub.type)}</td>
                    <td>${sub.date}</td>
                    <td><span class="status-badge ${badgeClass}">${sub.status}</span></td>
                    <td>${scoreText}</td> <td>
                        <button class="action-btn btn-view" onclick="viewSubmission('${linkToView}')">Xem</button>
                        <button class="action-btn ${actionButtonClass}" onclick="markSubmission('${sub.firebaseKey}')">${actionButtonText}</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }
    
    function loadAllSubmissions() {
        // H√†m n√†y g·ªçi filterSubmissions() sau khi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i qua loadAllSubmissionsFromFirebase()
    }
</script>