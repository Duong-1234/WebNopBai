<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√†i N·ªôp | Gi√°o Vi√™n 6A3</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f0f8ff; 
            color: #333;
        }
        .header {
            background-color: #388E3C; 
            color: white;
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 1.8em; font-weight: bold; }
        .nav-links { display: flex; align-items: center; }
        .nav-links a {
            color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-left: 10px;
            transition: background-color 0.3s;
        }
        .nav-links a.active { background-color: #4CAF50; font-weight: bold; }
        #user-info-container { display: flex; align-items: center; margin-left: 20px; }
        #welcome-user {
            color: #FFC107; font-weight: bold; margin-right: 20px; font-size: 1.1em; padding: 0;
        }
        #logout-btn { background-color: #e74c3c; cursor: pointer; padding: 8px 15px; }
        #logout-btn:hover { background-color: #c0392b; }

        .main-area { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

        .management-tools {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filter-group label { font-weight: bold; color: #388E3C; }
        .filter-group select, .filter-group input[type="search"] {
            padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; min-width: 150px;
        }
        #search-input { min-width: 250px; }
        .summary-note { font-style: italic; color: #555; font-size: 0.95em; }

        .history-section h2 {
            font-size: 2.2em; color: #388E3C; border-bottom: 3px solid #FFC107; padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .history-table {
            width: 100%; border-collapse: collapse; background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle;
        }
        .history-table th { background-color: #388E3C; color: white; font-weight: bold; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }

        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .status-new { background-color: #FFC107; color: #333; }
        .status-checked { background-color: #4CAF50; color: white; }

        .action-btn {
            padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: 600; margin-right: 5px; transition: opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.85; }
        .btn-view { background-color: #3498db; color: white; }
        .btn-check { background-color: #2ecc71; color: white; }
        .btn-revert { background-color: #f39c12; color: white; }

        .footer {
            padding: 20px; text-align: center; background-color: #333;
            color: white; font-size: 0.9em; margin-top: 40px;
        }
    </style>
</head>

<body onload="checkTeacherAccess()">
    <div class="header">
        <div class="logo">
            <span>L·ªöP 6A3 (QU·∫¢N L√ù)</span>
        </div>
        <div class="nav-links">
            <a href="trang_chu_gv.html">Trang Ch·ªß</a> 
            <a href="#" class="active">Ch·∫•m B√†i</a> 
            <div id="user-info-container">
                <span id="welcome-user"></span>
                <a href="#" onclick="logout()" id="logout-btn">ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="management-tools">
            <div class="filter-group">
                <label for="status-filter">Tr·∫°ng th√°i:</label>
                <select id="status-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="Ch∆∞a ch·∫•m">Ch∆∞a ch·∫•m</option>
                    <option value="ƒê√£ ch·∫•m">ƒê√£ ch·∫•m</option>
                </select>

                <label for="type-filter">Lo·∫°i b√†i:</label>
                <select id="type-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="video">Video/Thuy·∫øt tr√¨nh</option>
                    <option value="file">T√†i li·ªáu/File</option>
                    <option value="link">Li√™n k·∫øt</option>
                </select>

                <input type="search" id="search-input" placeholder="T√¨m ki·∫øm theo t√™n HS ho·∫∑c T√™n B√†i..." onkeyup="filterSubmissions()">
            </div>
            <div class="summary-note">
                <p>T·ªïng c·ªông: <span id="total-submissions-display" style="font-weight: bold;">0</span> b√†i n·ªôp.</p>
            </div>
        </div>
        
        <div class="history-section">
            <h2>üìù Danh S√°ch B√†i N·ªôp C·ªßa H·ªçc Sinh</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªçc Sinh</th>
                        <th>T√™n B√†i T·∫≠p</th>
                        <th>Lo·∫°i</th>
                        <th>Th·ªùi gian N·ªôp</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>ƒêi·ªÉm s·ªë</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="all-submissions-list"></tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        ¬© 2025 L·ªõp 6A3 Chuy√™n Anh | H·ªá th·ªëng Qu·∫£n L√Ω.
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Config (B·∫ÆT BU·ªòC: ph·∫£i kh·ªüi t·∫°o firebase + t·∫°o bi·∫øn auth, database) -->
    <script src="assets/js/firebase-config.js"></script>

    <script>
        let allSubmissions = [];
        let userDisplayNameMap = {};

        function safeLower(s) {
            return (s || '').toString().toLowerCase();
        }

        function displayType(type) {
            switch(type) {
                case 'video': return 'Video/TT';
                case 'file': return 'T√†i li·ªáu/File';
                case 'link': return 'Li√™n k·∫øt';
                default: return 'Kh√°c';
            }
        }

        function viewSubmission(encodedLink) {
            try {
                let link = decodeURIComponent(encodedLink || '');
                link = (link || '').trim();

                if (!link) {
                    alert("B√†i n·ªôp kh√¥ng c√≥ li√™n k·∫øt ƒë·ªÉ m·ªü.");
                    return;
                }
                if (link.startsWith("file:")) {
                    alert("B√†i n·ªôp n√†y l√† d·∫°ng File (Ghi ch√∫). Vui l√≤ng y√™u c·∫ßu h·ªçc sinh g·ª≠i file g·ªëc qua k√™nh kh√°c.");
                    return;
                }
                if (!(link.startsWith("http://") || link.startsWith("https://"))) {
                    link = `https://${link}`;
                }
                window.open(link, '_blank');
            } catch (e) {
                console.error(e);
                alert("Li√™n k·∫øt kh√¥ng h·ª£p l·ªá.");
            }
        }

        // 1) Load map h·ªçc sinh: uid -> displayName
        function loadUserMapFromFirebase() {
            return database.ref('users').once('value')
                .then(snapshot => {
                    userDisplayNameMap = {};
                    snapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const userData = childSnapshot.val() || {};
                        if (userData.role === 'hs') {
                            userDisplayNameMap[uid] = userData.displayName || 'H·ªçc Sinh';
                        }
                    });
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng:", error);
                });
        }

        // 2) Check quy·ªÅn GV + show name + load data
        function checkTeacherAccess() {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang qu·∫£n l√Ω.');
                    window.location.replace('dangnhap.html');
                    return;
                }

                database.ref('users/' + user.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val() || null;

                        if (!userData || userData.role !== 'gv') {
                            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Gi√°o vi√™n.');
                            return auth.signOut().finally(() => window.location.replace('dangnhap.html'));
                        }

                        document.getElementById('welcome-user').textContent =
                            `Xin ch√†o, ${userData.displayName || 'Gi√°o vi√™n'}!`;

                        // N·∫øu b·∫°n ƒëang d√πng trang m√£ GV (mat_ma_gv.html) v√† mu·ªën b·∫Øt bu·ªôc qua ƒë√≥:
                        // if (sessionStorage.getItem('isTeacherVerified') !== 'true') {
                        //     window.location.replace('mat_ma_gv.html');
                        //     return;
                        // }

                        return loadUserMapFromFirebase().then(loadAllSubmissionsFromFirebase);
                    })
                    .catch(error => {
                        console.error("L·ªói ki·ªÉm tra role:", error);
                        alert("L·ªói b·∫£o m·∫≠t. Vui l√≤ng th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i.");
                        auth.signOut().finally(() => window.location.replace('dangnhap.html'));
                    });
            });
        }

        // 3) Load submissions realtime
        function loadAllSubmissionsFromFirebase() {
            database.ref('submissions').on('value', (snapshot) => {
                allSubmissions = [];
                snapshot.forEach(childSnapshot => {
                    const s = childSnapshot.val() || {};
                    s.firebaseKey = childSnapshot.key;

                    // Chu·∫©n ho√° createdAt ƒë·ªÉ sort ƒë√∫ng (n·∫øu ch∆∞a c√≥)
                    // N·∫øu b·∫°n ch∆∞a l∆∞u createdAt khi HS n·ªôp b√†i -> n√™n th√™m sau.
                    if (typeof s.createdAt !== 'number') {
                        // fallback: th·ª≠ parse date string, kh√¥ng ch·∫Øc ƒë√∫ng
                        s.createdAt = Date.now();
                    }

                    allSubmissions.push(s);
                });
                filterSubmissions();
            }, (error) => {
                console.error("L·ªói khi t·∫£i b√†i n·ªôp:", error);
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i n·ªôp t·ª´ h·ªá th·ªëng.");
            });
        }

        // 4) Logout
        function logout() {
            auth.signOut().finally(() => {
                sessionStorage.removeItem('isTeacherVerified');
                window.location.replace('trang_chu.html');
            });
        }

        // 5) Mark (update status+score)
        function markSubmission(firebaseKey) {
            const submissionToMark = allSubmissions.find(sub => sub.firebaseKey === firebaseKey);
            if (!submissionToMark) {
                alert("Kh√¥ng t√¨m th·∫•y b√†i n·ªôp n√†y.");
                return;
            }

            const studentUid = submissionToMark.studentUid || '';
            const studentName = submissionToMark.displayName || userDisplayNameMap[studentUid] || 'H·ªçc Sinh';
            const title = submissionToMark.title || '(Kh√¥ng c√≥ t√™n b√†i)';
            const currentStatus = submissionToMark.status || 'Ch∆∞a ch·∫•m';
            const currentScore = (submissionToMark.score !== undefined && submissionToMark.score !== null)
                ? submissionToMark.score
                : 'Ch∆∞a c√≥';

            const ref = database.ref('submissions/' + firebaseKey);

            if (currentStatus === 'ƒê√£ ch·∫•m') {
                const action = confirm(
                    `B√†i "${title}" c·ªßa ${studentName} ƒë√£ ch·∫•m (${currentScore}/10).\n\nOK: H·ª¶Y CH·∫§M (v·ªÅ Ch∆∞a ch·∫•m)\nCancel: CH·∫§M L·∫†I`
                );

                let updates = {};

                if (action) {
                    updates = { status: 'Ch∆∞a ch·∫•m', score: null };
                } else {
                    let score = prompt(
                        `CH·∫§M L·∫†I b√†i "${title}" c·ªßa ${studentName}.\nƒêi·ªÉm hi·ªán t·∫°i: ${currentScore}/10. Nh·∫≠p ƒëi·ªÉm m·ªõi (0-10):`
                    );
                    if (score === null) return;
                    score = parseFloat(score);
                    if (isNaN(score) || score < 0 || score > 10) {
                        alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                        return;
                    }
                    updates = { status: 'ƒê√£ ch·∫•m', score: score };
                }

                ref.update(updates).catch(error => {
                    console.error("L·ªói c·∫≠p nh·∫≠t Firebase:", error);
                    alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm l√™n h·ªá th·ªëng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
                });

            } else {
                let score = prompt(`Ch·∫•m ƒëi·ªÉm cho b√†i "${title}" c·ªßa ${studentName}.\nNh·∫≠p ƒëi·ªÉm (0-10):`);
                if (score === null) return;
                score = parseFloat(score);

                if (isNaN(score) || score < 0 || score > 10) {
                    alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                    return;
                }

                ref.update({ status: 'ƒê√£ ch·∫•m', score: score }).catch(error => {
                    console.error("L·ªói c·∫≠p nh·∫≠t Firebase:", error);
                    alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm l√™n h·ªá th·ªëng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
                });
            }
        }

        // 6) Filter + render
        function filterSubmissions() {
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchInput = safeLower(document.getElementById('search-input').value);

            const tableBody = document.getElementById('all-submissions-list');
            tableBody.innerHTML = '';

            const filtered = allSubmissions.filter(sub => {
                const status = sub.status || 'Ch∆∞a ch·∫•m';
                const type = sub.type || 'link';

                const studentUid = sub.studentUid || '';
                const studentName = safeLower(sub.displayName || userDisplayNameMap[studentUid] || studentUid);
                const title = safeLower(sub.title);

                const statusMatch = statusFilter === 'all' || status === statusFilter;
                const typeMatch = typeFilter === 'all' || type === typeFilter;
                const searchMatch =
                    studentName.includes(searchInput) ||
                    title.includes(searchInput) ||
                    safeLower(studentUid).includes(searchInput);

                return statusMatch && typeMatch && searchMatch;
            });

            // Sort: ch∆∞a ch·∫•m l√™n tr∆∞·ªõc, r·ªìi m·ªõi theo createdAt gi·∫£m d·∫ßn
            filtered.sort((a, b) => {
                const sa = a.status || 'Ch∆∞a ch·∫•m';
                const sb = b.status || 'Ch∆∞a ch·∫•m';
                if (sa === 'Ch∆∞a ch·∫•m' && sb !== 'Ch∆∞a ch·∫•m') return -1;
                if (sa !== 'Ch∆∞a ch·∫•m' && sb === 'Ch∆∞a ch·∫•m') return 1;
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            document.getElementById('total-submissions-display').textContent = filtered.length;

            if (filtered.length === 0) {
                tableBody.innerHTML =
                    '<tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y b√†i n·ªôp n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc.</td></tr>';
                return;
            }

            filtered.forEach((sub, index) => {
                const status = sub.status || 'Ch∆∞a ch·∫•m';
                const badgeClass = status === 'Ch∆∞a ch·∫•m' ? 'status-new' : 'status-checked';

                let actionText = (status === 'Ch∆∞a ch·∫•m') ? 'Ch·∫•m B√†i' : 'Ch·∫•m L·∫°i/H·ªßy';
                let actionClass = (status === 'Ch∆∞a ch·∫•m') ? 'btn-check' : 'btn-revert';

                let scoreText = '<span style="color:#999;">--</span>';
                if (status === 'ƒê√£ ch·∫•m') {
                    const score = (sub.score !== undefined && sub.score !== null)
                        ? parseFloat(sub.score).toFixed(1)
                        : '??';
                    scoreText = `<span style="font-weight:bold; color:#E67E22;">${score}</span>/10`;
                }

                const studentUid = sub.studentUid || '';
                const studentDisplayName = sub.displayName || userDisplayNameMap[studentUid] || 'H·ªçc Sinh';
                const uidShort = studentUid ? studentUid.substring(0, 6) + '...' : 'N/A';

                const encodedLink = encodeURIComponent((sub.link || '').toString());

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight:600;">
                            ${studentDisplayName}
                            <span style="font-style: italic; color:#666;">(ID: ${uidShort})</span>
                        </td>
                        <td>${sub.title || ''}</td>
                        <td>${displayType(sub.type)}</td>
                        <td>${sub.date || ''}</td>
                        <td><span class="status-badge ${badgeClass}">${status}</span></td>
                        <td>${scoreText}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="viewSubmission('${encodedLink}')">Xem</button>
                            <button class="action-btn ${actionClass}" onclick="markSubmission('${sub.firebaseKey}')">${actionText}</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    </script>
</body>
</html>
