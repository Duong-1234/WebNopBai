<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script>
  const MAIN_MANAGEMENT_FILE = "chuc_nang_gv.html";
  const STATUS_LOGGED_IN = "ĐÃ XÁC MINH";
  const STATUS_PENDING = "Đang xác minh...";

  const form = document.getElementById('teacher-code-form');
  const errorDisplay = document.getElementById('login-error');
  const codeInput = document.getElementById('initial-teacher-code');
  const userInfoDisplay = document.getElementById('user-info-display');

  function getCurrentUser() {
    const raw = localStorage.getItem('currentUser');
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function requireGv() {
    const user = getCurrentUser();
    if (!user) {
      alert("Bạn chưa đăng nhập. Vui lòng đăng nhập lại.");
      window.location.href = "dangnhap.html";
      return null;
    }
    if (user.role !== 'gv') {
      alert("Bạn không có quyền truy cập. Chỉ giáo viên mới vào được.");
      window.location.href = "trang_chu.html";
      return null;
    }
    return user;
  }

  // Mỗi lần vào trang vẫn bắt nhập mã lại (giữ đúng ý bạn)
  sessionStorage.removeItem('isTeacherVerified');

  userInfoDisplay.textContent = STATUS_PENDING;

  const gvUser = requireGv();
  if (gvUser) {
    userInfoDisplay.textContent = `GV: ${gvUser.displayName || gvUser.username}`;
  }

  form.addEventListener('submit', function(event) {
    event.preventDefault();

    const enteredCode = codeInput.value.trim();
    errorDisplay.style.display = 'none';

    if (!enteredCode) {
      errorDisplay.textContent = "Vui lòng nhập mã giáo viên.";
      errorDisplay.style.display = 'block';
      return;
    }

    // Lấy mã từ Firebase thay vì hard-code
    db.ref('config/teacherCode').once('value')
      .then(snap => {
        const realCode = snap.val();
        if (!realCode) {
          throw new Error("Chưa cấu hình config/teacherCode trong Firebase.");
        }

        if (enteredCode === String(realCode)) {
          sessionStorage.setItem('isTeacherVerified', 'true');
          sessionStorage.setItem('teacherDisplayName', STATUS_LOGGED_IN);
          window.location.href = MAIN_MANAGEMENT_FILE;
        } else {
          errorDisplay.textContent = "Mã Giáo viên không chính xác. Quyền truy cập bị từ chối.";
          errorDisplay.style.display = 'block';
        }
      })
      .catch(err => {
        console.error(err);
        errorDisplay.textContent = "Lỗi xác minh (Firebase). Mở Console để xem.";
        errorDisplay.style.display = 'block';
      });
  });
</script>
