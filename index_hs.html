<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N·ªôp B√†i T·∫≠p | H·ªçc Sinh 6A3</title>
  <style>
    /* CSS KH√îNG THAY ƒê·ªîI, ƒê∆Ø·ª¢C GI·ªÆ NGUY√äN */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f8ff;
      color: #333;
    }
    .header {
      background-color: #388E3C;
      color: white;
      padding: 10px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 1.8em;
      font-weight: bold;
    }
    .logo span { margin-left: 10px; }
    .nav-links { display: flex; align-items: center; }
    .nav-links a {
      color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-left: 10px;
      transition: background-color 0.3s;
    }
    .nav-links a.active { background-color: #4CAF50; font-weight: bold; }

    #user-info-container { display: flex; align-items: center; margin-left: 20px; }
    #user-avatar {
      width: 30px; height: 30px; border-radius: 50%;
      margin-right: 8px; border: 2px solid #FFC107;
    }
    #welcome-user { color: #FFC107; font-weight: bold; margin-right: 20px; font-size: 1.1em; }
    #logout-btn { background-color: #e74c3c; cursor: pointer; padding: 8px 15px; }
    #logout-btn:hover { background-color: #c0392b; }

    .main-area { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .submission-area {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 40px;
    }
    .submission-area h2 { font-size: 2em; color: #388E3C; margin-bottom: 20px; }
    .submission-box { border: 1px solid #4CAF50; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .submission-box label { display: block; font-weight: bold; margin-top: 15px; color: #388E3C; }
    .submission-box input[type="text"],
    .submission-box input[type="file"],
    .submission-box select {
      width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ccc;
      border-radius: 4px; font-size: 1em; background-color: white; cursor: pointer;
    }
    .submission-box button[type="submit"] {
      background-color: #4CAF50; color: white; padding: 10px 20px; border: none;
      border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 20px;
      transition: background-color 0.3s;
    }
    .submission-box button[type="submit"]:hover { background-color: #388E3C; }

    .history-section h2 {
      font-size: 1.8em; color: #388E3C; border-bottom: 2px solid #FFC107; padding-bottom: 10px;
      margin-bottom: 20px; margin-top: 40px;
    }
    .history-table {
      width: 100%; border-collapse: collapse; background-color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .history-table th, .history-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .history-table th { background-color: #FFC107; color: #333; font-weight: bold; }
    .history-table tr:nth-child(even) { background-color: #fffaf0; }
    .history-table a { color: #388E3C; text-decoration: none; font-weight: 600; }
    .status-new { background-color: #f2f2f2; color: #333; }
    .status-checked { background-color: #4CAF50; color: white; }
    .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }

    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 5px;
      transition: opacity 0.2s;
    }
    .action-btn:hover { opacity: 0.8; }
    .btn-delete { background-color: #e74c3c; color: white; }

    .footer {
      padding: 20px; text-align: center; background-color: #333;
      color: white; font-size: 0.9em; margin-top: 40px;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="logo" onclick="window.location.href='trang_chu.html'">
      <span>L·ªöP 6A3</span>
    </div>

    <div class="nav-links">
      <a href="trang_chu.html">Trang Ch·ªß</a>
      <a href="#" class="active">N·ªôp B√†i</a>

      <div id="user-info-container">
        <img id="user-avatar" src="https://maunailxinh.com/wp-content/uploads/2025/06/avatar-an-danh-1.jpg" alt="Avatar">
        <span id="welcome-user"></span>
        <a href="#" onclick="logout()" id="logout-btn">ƒêƒÉng Xu·∫•t</a>
      </div>
    </div>
  </div>

  <div class="main-area">
    <div class="submission-area">
      <h2>Khu v·ª±c N·ªôp B√†i T·∫≠p</h2>
      <p>Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i, <b id="current-display-name"></b>. B·∫Øt ƒë·∫ßu n·ªôp b√†i t·∫≠p c·ªßa b·∫°n.</p>

      <div class="submission-box">
        <h3>N·ªôp B√†i T·∫≠p M·ªõi</h3>

        <form id="submission-form">
          <label for="ten-bai-tap">T√™n B√†i T·∫≠p:</label>
          <input type="text" id="ten-bai-tap" required placeholder="L∆∞u √Ω: Ghi t√™n ch·ªß ƒë·ªÉ thuy·∫øt tr√¨nh v√† t√™n m√¥n h·ªçc !">

          <label for="loai-bai-tap">Lo·∫°i B√†i N·ªôp:</label>
          <select id="loai-bai-tap" required>
            <option value="" disabled selected>-- Ch·ªçn lo·∫°i b√†i n·ªôp --</option>
            <option value="video">Video/Thuy·∫øt tr√¨nh</option>
            <option value="file">T√†i li·ªáu/File (PDF/Word)</option>
            <option value="link">Li√™n k·∫øt kh√°c (Website/Canva)</option>
          </select>

          <div id="submission-input-container">
            <label for="lien-ket" id="link-label">D√°n Li√™n k·∫øt (Google Drive/YouTube/v.v.):</label>
            <input type="text" id="lien-ket" required placeholder="Li√™n k·∫øt ƒë·∫øn file ho·∫∑c video...">
          </div>

          <button type="submit">G·ª≠i B√†i N·ªôp</button>
        </form>
      </div>
    </div>

    <div class="history-section">
      <h2>üìù L·ªãch s·ª≠ B√†i n·ªôp c·ªßa b·∫°n</h2>
      <table class="history-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>T√™n B√†i T·∫≠p</th>
            <th>Lo·∫°i B√†i N·ªôp</th>
            <th>Th·ªùi gian N·ªôp</th>
            <th>Li√™n k·∫øt/File</th>
            <th>Tr·∫°ng th√°i</th>
            <th>ƒêi·ªÉm s·ªë</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="my-submissions-list"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    ¬© 2025 L·ªõp 6A3 Chuy√™n Anh | H·ªá th·ªëng N·ªôp B√†i.
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Config -->
  <script src="assets/js/firebase-config.js"></script>

  <script>
    // ====== SESSION + ACCESS ======
    let currentUser = null;

    function getCurrentUser() {
      const raw = localStorage.getItem('currentUser');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function requireHsAccess() {
      currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'hs') {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n H·ªçc sinh.');
        window.location.href = 'dangnhap.html';
        return false;
      }

      document.getElementById('current-display-name').textContent = currentUser.displayName || currentUser.username;
      document.getElementById('welcome-user').textContent = `Xin ch√†o, ${(currentUser.displayName || currentUser.username)}!`;
      return true;
    }

    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'trang_chu.html';
    }

    // ====== UI helpers ======
    function displayType(type) {
      switch (type) {
        case 'video': return 'Video/TT';
        case 'file': return 'T√†i li·ªáu/File';
        case 'link': return 'Li√™n k·∫øt';
        default: return 'Kh√°c';
      }
    }

    function normalizeLink(link) {
      let x = (link || '').trim();
      if (!x) return x;
      if (!x.startsWith('http://') && !x.startsWith('https://')) x = 'https://' + x;
      return x;
    }

    function viewSubmission(link) {
      const x = normalizeLink(link);
      window.open(x, '_blank');
    }

    // ====== Firebase submissions ======
    function pushSubmissionToFirebase(data) {
      // submissions/<pushKey>
      return db.ref('submissions').push(data);
    }

    function deleteSubmissionByKey(key) {
      return db.ref('submissions/' + key).remove();
    }

    function loadMySubmissions() {
      const tableBody = document.getElementById('my-submissions-list');
      tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">ƒêang t·∫£i...</td></tr>';

      // Query theo username
      db.ref('submissions')
        .orderByChild('username')
        .equalTo(currentUser.username)
        .once('value')
        .then((snap) => {
          const rows = [];
          snap.forEach(child => {
            const v = child.val();
            rows.push({ key: child.key, ...v });
          });

          // sort m·ªõi nh·∫•t tr∆∞·ªõc
          rows.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

          if (rows.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">B·∫°n ch∆∞a n·ªôp b√†i t·∫≠p n√†o.</td></tr>';
            return;
          }

          tableBody.innerHTML = '';
          rows.forEach((sub, index) => {
            const badgeClass = sub.status === 'Ch∆∞a ch·∫•m' ? 'status-new' : 'status-checked';

            let scoreText = `<span style="color:#E74C3C;">Ch∆∞a ch·∫•m</span>`;
            if (sub.status === 'ƒê√£ ch·∫•m' && sub.score !== undefined && sub.score !== null) {
              const score = Number(sub.score);
              if (!Number.isNaN(score)) scoreText = `<span style="font-weight:bold; color:#16A085;">${score.toFixed(1)}</span>/10`;
            }

            const linkBtn = `<button class="action-btn" style="background-color:#3498db; color:white;" onclick="viewSubmission('${(sub.link || '').replace(/'/g, "\\'")}')">Xem Link</button>`;

            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${sub.title || ''}</td>
                <td>${displayType(sub.type)}</td>
                <td>${sub.date || ''}</td>
                <td>${linkBtn}</td>
                <td><span class="status-badge ${badgeClass}">${sub.status || 'Ch∆∞a ch·∫•m'}</span></td>
                <td>${scoreText}</td>
                <td>
                  <button class="action-btn btn-delete" onclick="handleDelete('${sub.key}')">X√≥a</button>
                </td>
              </tr>
            `;
            tableBody.innerHTML += row;
          });
        })
        .catch((err) => {
          console.error(err);
          tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#e74c3c;">L·ªói t·∫£i d·ªØ li·ªáu. M·ªü Console ƒë·ªÉ xem.</td></tr>';
        });
    }

    function handleDelete(key) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i n·ªôp n√†y?')) return;

      deleteSubmissionByKey(key)
        .then(() => {
          alert('ƒê√£ x√≥a b√†i n·ªôp.');
          loadMySubmissions();
        })
        .catch((err) => {
          console.error(err);
          alert('Kh√¥ng x√≥a ƒë∆∞·ª£c. Ki·ªÉm tra Rules/Console.');
        });
    }

    // ====== Submit handler ======
    function handleSubmitSubmission(event) {
      event.preventDefault();

      const title = document.getElementById('ten-bai-tap').value.trim();
      const type = document.getElementById('loai-bai-tap').value;
      const linkEl = document.getElementById('lien-ket');
      const link = normalizeLink(linkEl ? linkEl.value : '');

      if (!title || !type || !link) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n B√†i T·∫≠p, Lo·∫°i B√†i N·ªôp v√† Li√™n k·∫øt!');
        return;
      }

      const submissionData = {
        title: title,
        type: type,
        link: link,

        username: currentUser.username,
        displayName: currentUser.displayName || currentUser.username,

        date: new Date().toLocaleString('vi-VN'),
        createdAt: Date.now(),

        status: 'Ch∆∞a ch·∫•m',
        score: null
      };

      pushSubmissionToFirebase(submissionData)
        .then(() => {
          alert('üéâ N·ªôp b√†i th√†nh c√¥ng! Gi√°o vi√™n s·∫Ω th·∫•y b√†i c·ªßa b·∫°n trong h·ªá th·ªëng.');
          document.getElementById('submission-form').reset();
          document.getElementById('loai-bai-tap').value = '';
          setupFormInteraction();
          loadMySubmissions();
        })
        .catch((err) => {
          console.error(err);
          alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c b√†i. Ki·ªÉm tra Rules/Console.');
        });
    }

    // ====== Form dynamic input (gi·ªØ logic b·∫°n ƒëang c√≥, ch·ªâ l√†m g·ªçn & an to√†n) ======
    function setupFormInteraction() {
      const loaiBaiTapSelect = document.getElementById('loai-bai-tap');
      const inputContainer = document.getElementById('submission-input-container');

      function updateInputFields(selectedValue) {
        let content = '';
        const guideLink = "https://www.youtube.com/watch?v=IZ7TwQej_WU";

        if (selectedValue === 'video' || selectedValue === 'file') {
          const specificRecommendationText =
            selectedValue === 'video'
              ? 'H√ÉY CHUY·ªÇN **VIDEO** C·ª¶A B·∫†N V·ªÄ GOOGLE DRIVE/YOUTUBE V√Ä N·ªòP V√ÄO PH·∫¶N **LI√äN K·∫æT** (B√äN D∆Ø·ªöI) ƒê·ªÇ TR√ÅNH L·ªñI.'
              : 'H√ÉY CHUY·ªÇN **FILE T√ÄI LI·ªÜU** C·ª¶A B·∫†N (n·∫øu t·ªáp l·ªõn) V·ªÄ GOOGLE DRIVE V√Ä N·ªòP V√ÄO PH·∫¶N **LI√äN K·∫æT** (B√äN D∆Ø·ªöI) ƒê·ªÇ ƒê·∫¢M B·∫¢O CH·∫§T L∆Ø·ª¢NG.';

          content = `
            <div style="margin-top: 10px; padding: 15px; border: 2px solid #e74c3c; background-color: #fff4f4; border-radius: 6px; margin-bottom: 15px;">
              <p style="font-weight: bold; color: #e74c3c; margin-top: 0; font-size: 1.1em;">
                üö´ CH·ª®C NƒÇNG T·∫¢I T·ªÜP TR·ª∞C TI·∫æP KH√îNG KH·∫¢ D·ª§NG
              </p>
              <p style="font-weight: bold; color: #e74c3c; margin-bottom: 5px;">
                ‚ö†Ô∏è Vui l√≤ng CH·ªà n·ªôp b·∫±ng LI√äN K·∫æT. B√†i n·ªôp d·∫°ng file tr·ª±c ti·∫øp s·∫Ω kh√¥ng ƒë∆∞·ª£c gi√°o vi√™n nh·∫≠n.
              </p>
              <p style="font-weight: bold; color: #3498db; margin-bottom: 5px;">
                üí° KHUY·∫æN NGH·ªä: ${specificRecommendationText}
              </p>
              <hr style="border-top: 1px solid #e74c3c; margin: 10px 0;">
              <p style="font-size: 0.9em; margin-bottom: 0;">
                N·∫øu kh√¥ng bi·∫øt c√°ch chuy·ªÉn l√™n Google Drive/YouTube, h√£y xem h∆∞·ªõng d·∫´n sau:
                <br>
                <a href="${guideLink}" target="_blank" style="color: #27ae60; font-weight: bold; text-decoration: none;">
                  Xem H∆∞·ªõng D·∫´n Chi Ti·∫øt
                </a>
              </p>
            </div>
            <label for="lien-ket">D√°n Li√™n k·∫øt ƒë√£ chuy·ªÉn (Google Drive/YouTube/v.v.):</label>
            <input type="text" id="lien-ket" required placeholder="Li√™n k·∫øt ƒë·∫øn file ho·∫∑c video...">
          `;
        } else if (selectedValue === 'link') {
          content = `
            <label for="lien-ket">D√°n Li√™n k·∫øt (Website/Canva/Google Drive/YouTube):</label>
            <input type="text" id="lien-ket" required placeholder="D√°n li√™n k·∫øt d·ª± √°n video, ...">
          `;
        } else {
          content = `
            <label for="lien-ket">D√°n Li√™n k·∫øt:</label>
            <input type="text" id="lien-ket" disabled placeholder="Vui l√≤ng ch·ªçn Lo·∫°i B√†i N·ªôp tr∆∞·ªõc...">
          `;
        }

        inputContainer.innerHTML = content;
      }

      updateInputFields(loaiBaiTapSelect.value);

      loaiBaiTapSelect.onchange = function () {
        updateInputFields(this.value);
      };
    }

    function setupSubmissionHandler() {
      const form = document.getElementById('submission-form');
      form.removeEventListener('submit', handleSubmitSubmission);
      form.addEventListener('submit', handleSubmitSubmission);
    }

    // ====== init ======
    document.addEventListener('DOMContentLoaded', () => {
      if (!requireHsAccess()) return;

      setupFormInteraction();
      setupSubmissionHandler();
      loadMySubmissions();
    });
  </script>
</body>
</html>
